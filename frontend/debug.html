<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¯¦ç»†è°ƒè¯•å·¥å…·</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            background: #1e1e1e;
            color: #d4d4d4;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: #252526;
            padding: 20px;
            border-radius: 8px;
        }
        h1 { color: #4ec9b0; }
        input {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            background: #3c3c3c;
            border: 1px solid #555;
            color: #d4d4d4;
            font-size: 14px;
        }
        button {
            padding: 10px 20px;
            background: #0e639c;
            color: white;
            border: none;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #1177bb; }
        .log {
            background: #1e1e1e;
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
            max-height: 400px;
            overflow-y: auto;
            font-size: 12px;
        }
        .success { color: #4ec9b0; }
        .error { color: #f48771; }
        .warning { color: #dcdcaa; }
        .info { color: #9cdcfe; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”¬ è¯¦ç»†è°ƒè¯•å·¥å…·</h1>
        
        <div>
            <label>API Key:</label>
            <input type="password" id="apiKey" placeholder="è¾“å…¥API Key">
        </div>
        
        <div>
            <button onclick="testBasicConnection()">1. æµ‹è¯•åŸºç¡€è¿æ¥</button>
            <button onclick="testAPIKey()">2. æµ‹è¯•API Key</button>
            <button onclick="testQwenMax()">3. æµ‹è¯•qwen-max</button>
            <button onclick="testQwenVL()">4. æµ‹è¯•qwen-vl-max</button>
            <button onclick="clearLog()">æ¸…é™¤æ—¥å¿—</button>
        </div>
        
        <div class="log" id="log"></div>
    </div>
    
    <script>
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            logDiv.innerHTML += `<div class="${type}">[${time}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }
        
        async function testBasicConnection() {
            log('å¼€å§‹æµ‹è¯•åŸºç¡€è¿æ¥...', 'info');
            
            try {
                const response = await fetch('https://dashscope.aliyuncs.com/', {
                    method: 'GET',
                    mode: 'cors'
                });
                
                log(`âœ“ åŸºç¡€è¿æ¥æˆåŠŸï¼ŒçŠ¶æ€ç : ${response.status}`, 'success');
                log(`æœåŠ¡å™¨ç±»å‹: ${response.headers.get('server')}`, 'info');
                
            } catch (error) {
                log(`âœ— åŸºç¡€è¿æ¥å¤±è´¥: ${error.message}`, 'error');
                log(`é”™è¯¯è¯¦æƒ…: ${JSON.stringify(error)}`, 'error');
            }
        }
        
        async function testAPIKey() {
            const apiKey = document.getElementById('apiKey').value.trim();
            
            if (!apiKey) {
                log('âœ— è¯·å…ˆè¾“å…¥API Key', 'error');
                return;
            }
            
            log('å¼€å§‹æµ‹è¯•API Keyæœ‰æ•ˆæ€§...', 'info');
            log(`API Keyé•¿åº¦: ${apiKey.length}`, 'info');
            log(`API Keyå‰ç¼€: ${apiKey.substring(0, 5)}...`, 'info');
            
            // æ£€æŸ¥éASCIIå­—ç¬¦
            const hasNonAscii = /[^\x00-\x7F]/.test(apiKey);
            if (hasNonAscii) {
                log('âœ— è­¦å‘Š: API KeyåŒ…å«éASCIIå­—ç¬¦', 'warning');
            } else {
                log('âœ“ API KeyåªåŒ…å«ASCIIå­—ç¬¦', 'success');
            }
        }
        
        async function testQwenMax() {
            const apiKey = document.getElementById('apiKey').value.trim();
            
            if (!apiKey) {
                log('âœ— è¯·å…ˆè¾“å…¥API Key', 'error');
                return;
            }
            
            log('===== æµ‹è¯•qwen-maxæ¨¡å‹ =====', 'warning');
            
            try {
                log('æ„å»ºè¯·æ±‚...', 'info');
                
                const headers = new Headers();
                headers.append('Content-Type', 'application/json');
                headers.append('Authorization', 'Bearer ' + apiKey);
                
                log('è¯·æ±‚URL: https://dashscope.aliyuncs.com/api/v1/services/aigc/text-generation/generation', 'info');
                log('æ¨¡å‹: qwen-max', 'info');
                
                const requestBody = {
                    model: 'qwen-max',
                    input: {
                        messages: [{
                            role: 'user',
                            content: 'Hello'
                        }]
                    },
                    parameters: {
                        result_format: 'message'
                    }
                };
                
                log('è¯·æ±‚ä½“: ' + JSON.stringify(requestBody, null, 2), 'info');
                
                log('å‘é€è¯·æ±‚...', 'info');
                const startTime = Date.now();
                
                const response = await fetch('https://dashscope.aliyuncs.com/api/v1/services/aigc/text-generation/generation', {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(requestBody)
                });
                
                const duration = Date.now() - startTime;
                log(`å“åº”æ—¶é—´: ${duration}ms`, 'info');
                log(`å“åº”çŠ¶æ€: ${response.status} ${response.statusText}`, response.ok ? 'success' : 'error');
                
                // æ˜¾ç¤ºæ‰€æœ‰å“åº”å¤´
                log('å“åº”å¤´:', 'info');
                response.headers.forEach((value, key) => {
                    log(`  ${key}: ${value}`, 'info');
                });
                
                const responseText = await response.text();
                log('å“åº”å†…å®¹:', 'info');
                log(responseText, response.ok ? 'success' : 'error');
                
                if (response.ok) {
                    try {
                        const data = JSON.parse(responseText);
                        if (data.output && data.output.choices) {
                            log('âœ“ qwen-maxæ¨¡å‹æµ‹è¯•æˆåŠŸï¼', 'success');
                            log(`AIå›å¤: ${data.output.choices[0].message.content}`, 'success');
                        }
                    } catch (e) {
                        log('è§£æå“åº”å¤±è´¥: ' + e.message, 'error');
                    }
                } else {
                    log('âœ— qwen-maxæ¨¡å‹æµ‹è¯•å¤±è´¥', 'error');
                    
                    if (response.status === 401) {
                        log('åŸå› : API Keyæ— æ•ˆæˆ–å·²è¿‡æœŸ', 'error');
                    } else if (response.status === 400) {
                        log('åŸå› : è¯·æ±‚æ ¼å¼é”™è¯¯æˆ–æ¨¡å‹æœªå¼€é€š', 'error');
                    } else if (response.status === 429) {
                        log('åŸå› : è¯·æ±‚è¿‡äºé¢‘ç¹', 'error');
                    }
                }
                
            } catch (error) {
                log(`âœ— è¯·æ±‚å¤±è´¥: ${error.message}`, 'error');
                log(`é”™è¯¯ç±»å‹: ${error.name}`, 'error');
                log(`é”™è¯¯å †æ ˆ: ${error.stack}`, 'error');
                
                if (error.message.includes('Failed to fetch')) {
                    log('è¿™æ˜¯CORSæˆ–ç½‘ç»œè¿æ¥é—®é¢˜', 'warning');
                    log('è¯·ç¡®ä¿é€šè¿‡ http://localhost:8000 è®¿é—®æ­¤é¡µé¢', 'warning');
                }
            }
        }
        
        async function testQwenVL() {
            const apiKey = document.getElementById('apiKey').value.trim();
            
            if (!apiKey) {
                log('âœ— è¯·å…ˆè¾“å…¥API Key', 'error');
                return;
            }
            
            log('===== æµ‹è¯•qwen-vl-maxæ¨¡å‹ =====', 'warning');
            
            try {
                log('æ„å»ºè¯·æ±‚...', 'info');
                
                const headers = new Headers();
                headers.append('Content-Type', 'application/json');
                headers.append('Authorization', 'Bearer ' + apiKey);
                
                // åˆ›å»ºä¸€ä¸ªç®€å•çš„æµ‹è¯•å›¾ç‰‡ï¼ˆ1x1åƒç´ çš„ç™½è‰²PNGï¼‰
                const testImage = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mP8/5+hHgAHggJ/PchI7wAAAABJRU5ErkJggg==';
                
                const requestBody = {
                    model: 'qwen-vl-max',
                    input: {
                        messages: [{
                            role: 'user',
                            content: [
                                { image: testImage },
                                { text: 'What is this?' }
                            ]
                        }]
                    }
                };
                
                log('å‘é€è¯·æ±‚...', 'info');
                const startTime = Date.now();
                
                const response = await fetch('https://dashscope.aliyuncs.com/api/v1/services/aigc/multimodal-generation/generation', {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(requestBody)
                });
                
                const duration = Date.now() - startTime;
                log(`å“åº”æ—¶é—´: ${duration}ms`, 'info');
                log(`å“åº”çŠ¶æ€: ${response.status} ${response.statusText}`, response.ok ? 'success' : 'error');
                
                const responseText = await response.text();
                log('å“åº”å†…å®¹:', 'info');
                log(responseText, response.ok ? 'success' : 'error');
                
                if (response.ok) {
                    log('âœ“ qwen-vl-maxæ¨¡å‹æµ‹è¯•æˆåŠŸï¼', 'success');
                } else {
                    log('âœ— qwen-vl-maxæ¨¡å‹æµ‹è¯•å¤±è´¥', 'error');
                    
                    if (response.status === 400) {
                        log('åŸå› : å¯èƒ½æ˜¯qwen-vl-maxæ¨¡å‹æœªå¼€é€š', 'error');
                        log('è§£å†³æ–¹æ³•: è®¿é—® https://bailian.console.aliyun.com/ å¼€é€šæ¨¡å‹', 'warning');
                    }
                }
                
            } catch (error) {
                log(`âœ— è¯·æ±‚å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶æ˜¾ç¤ºç¯å¢ƒä¿¡æ¯
        window.addEventListener('load', () => {
            log('=== ç¯å¢ƒä¿¡æ¯ ===', 'warning');
            log(`æµè§ˆå™¨: ${navigator.userAgent}`, 'info');
            log(`å½“å‰URL: ${window.location.href}`, 'info');
            log(`åè®®: ${window.location.protocol}`, 'info');
            
            if (window.location.protocol === 'file:') {
                log('âš ï¸ è­¦å‘Š: æ‚¨æ­£åœ¨ä½¿ç”¨file://åè®®ï¼Œè¿™ä¼šå¯¼è‡´CORSé”™è¯¯', 'error');
                log('è¯·é€šè¿‡ http://localhost:8000/debug.html è®¿é—®', 'warning');
            } else {
                log('âœ“ ä½¿ç”¨æ­£ç¡®çš„HTTPåè®®', 'success');
            }
        });
    </script>
</body>
</html>
