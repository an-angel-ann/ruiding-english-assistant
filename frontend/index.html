<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¿å®AIè‹±è¯­å­¦ä¹ åŠ©æ‰‹</title>
    <link rel="stylesheet" href="styles.css?v=7.14">
</head>
<style>
/* ä¼˜é›…çš„èœå•æŒ‰é’®æ ·å¼ */
.logout-btn-content {
    padding: 20px !important;
    min-width: 300px !important;
}

.logout-btn-content a,
.logout-btn-content button {
    display: block;
    width: 100%;
    padding: 12px 16px;
    margin-bottom: 10px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    border-radius: 10px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    text-align: center;
    text-decoration: none;
    box-sizing: border-box;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
}

.logout-btn-content a:last-of-type,
.logout-btn-content button:last-of-type {
    margin-bottom: 0;
}

.logout-btn-content .btn-logout {
    background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
    margin-top: 4px;
    box-shadow: 0 2px 8px rgba(255, 107, 107, 0.3);
}

/* æ‚¬åœæ•ˆæœ */
.logout-btn-content a:hover,
.logout-btn-content button:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 16px rgba(102, 126, 234, 0.5);
}

.logout-btn-content .btn-logout:hover {
    box-shadow: 0 6px 16px rgba(255, 107, 107, 0.5);
}

/* ç‚¹å‡»æ•ˆæœ */
.logout-btn-content a:active,
.logout-btn-content button:active {
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(102, 126, 234, 0.4);
}

/* è¯­éŸ³é€‰æ‹©å™¨æ ·å¼ */
.voice-selector {
    position: fixed;
    top: 20px;
    left: 20px;
    z-index: 1000;
    cursor: pointer;
}

.voice-selector-icon {
    width: 50px;
    height: 50px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    transition: all 0.3s ease;
}

.voice-selector:hover .voice-selector-icon {
    transform: scale(1.1);
    box-shadow: 0 6px 16px rgba(102, 126, 234, 0.6);
}

.voice-selector-content {
    position: absolute;
    top: 60px;
    left: 0;
    background: white;
    border-radius: 12px;
    padding: 16px;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
    min-width: 280px;
    max-height: 400px;
    overflow-y: auto;
    opacity: 0;
    visibility: hidden;
    transform: translateY(-10px);
    transition: all 0.3s ease;
    pointer-events: none;
    z-index: 1000;
}

.voice-selector-content.active {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
    pointer-events: auto;
}
</style>
<body>
    <div class="container">
        <!-- è¯­éŸ³é€‰æ‹©å™¨ï¼ˆå›ºå®šåœ¨å·¦ä¸Šè§’ï¼‰ -->
        <div id="voiceSelector" class="voice-selector" style="display: none;">
            <div class="voice-selector-icon" onclick="toggleVoicePanel()">ğŸ”Š</div>
            <div class="voice-selector-content" id="voiceSelectorContent">
                <h4 style="margin: 0 0 12px 0; color: #667eea; font-size: 14px;">é€‰æ‹©å‘éŸ³</h4>
                <select id="voiceSelect" onchange="changeVoice()" style="width: 100%; padding: 8px; border: 1px solid #e0e0e0; border-radius: 8px; font-size: 13px; margin-bottom: 10px;">
                    <option value="">åŠ è½½ä¸­...</option>
                </select>
                <div style="display: flex; gap: 8px; margin-top: 8px;">
                    <button onclick="testVoice()" style="flex: 1; padding: 6px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px;">è¯•å¬</button>
                    <button onclick="closeVoicePanel()" style="flex: 1; padding: 6px; background: #e0e0e0; color: #666; border: none; border-radius: 6px; cursor: pointer; font-size: 12px;">å…³é—­</button>
                </div>
            </div>
        </div>
        
        <!-- ç™»å‡ºæŒ‰é’®ï¼ˆå›ºå®šåœ¨å³ä¸Šè§’ - åœ†å½¢è®¾è®¡ï¼‰ -->
        <div id="logoutButton" class="logout-btn" style="display: none;" data-menu-initialized="true">
            <div class="logout-btn-icon">ğŸ‘¤</div>
            <div class="logout-btn-content">
                <span id="userEmailDisplay"></span>
                <a href="/subscription.html" class="btn-subscription">ğŸ’ ä¼šå‘˜è®¢é˜…</a>
                <button onclick="showDeviceManager()" class="btn-subscription" style="margin-top: 5px;">ğŸ“± è®¾å¤‡ç®¡ç†</button>
                <button onclick="window.location.href='/index.html'" class="btn-subscription" style="margin-top: 5px;">ğŸ  è¿”å›ä¸»é¡µ</button>
                <button onclick="handleLogout()" class="btn-logout">ç™»å‡º</button>
            </div>
        </div>

        <!-- API Key é…ç½®é¢æ¿ -->
        <div id="apiKeyPanel" class="panel subscription-panel" style="display: none;" data-menu-initialized="true">
            <div class="subscription-content">
                <div class="subscription-icon">ğŸ“</div>
                <h1 class="subscription-title">ç¿å®AIè‹±è¯­å­¦ä¹ åŠ©æ‰‹</h1>
                
                <h2 class="subscription-heading">å¼€å¯AIæ™ºèƒ½å­¦ä¹ </h2>
                
                <div class="subscription-feature">
                    <div class="feature-highlight">ğŸ’ è®¢é˜…ä¼šå‘˜å³å¯è§£é”å…¨éƒ¨AIåŠŸèƒ½</div>
                    <p class="feature-desc">äº«å—æ™ºèƒ½åˆ†æã€ä¸ªæ€§åŒ–å­¦ä¹ è·¯å¾„ã€ä¼˜å…ˆæ”¯æŒç­‰ç‰¹æƒ</p>
                </div>
                
                <div class="subscription-cta">
                    <a href="/subscription.html" class="btn-subscribe-main">
                        <span class="btn-icon">ğŸš€</span>
                        <span class="btn-text">ç«‹å³è®¢é˜…ä¼šå‘˜</span>
                    </a>
                </div>
                
                <p class="subscription-trial">æ–°ç”¨æˆ·æ³¨å†Œå³äº«7å¤©å…è´¹ä½“éªŒ</p>
            </div>
        </div>

        <!-- æ¨¡å¼é€‰æ‹©é¢æ¿ -->
        <div id="modeSelectionPanel" class="panel" style="display: none;" data-menu-initialized="true">
            <a id="modes" style="position: relative; top: -80px; display: block;"></a>
            <h1>ğŸ“ é€‰æ‹©å­¦ä¹ æ¨¡å¼</h1>
            <div class="mode-selection">
                <div class="mode-card" onclick="selectMode('sentence')">
                    <div class="mode-icon">ğŸ“–</div>
                    <h2>å¥å­å­¦ä¹ </h2>
                    <p>ä¸Šä¼ è‹±è¯­ææ–™ï¼Œè¿›è¡Œå¥å­åˆ†æã€è¯ä¹‰è¾¨åˆ«ã€ç»“æ„åˆ†æå’Œå¥å­é‡ç»„ç»ƒä¹ </p>
                    <div class="mode-badge">åŸåŠŸèƒ½</div>
                </div>
                <div class="mode-card" onclick="selectMode('word')">
                    <div class="mode-icon">ğŸ“š</div>
                    <h2>å•è¯å­¦ä¹ </h2>
                    <p>ä¸Šä¼ å•è¯ï¼Œé€šè¿‡æ•…äº‹è®°å¿†æ³•å­¦ä¹ å•è¯ï¼ŒæŒæ¡è¯ä¹‰ã€è¯æ€§å’Œç”¨æ³•</p>
                    <div class="mode-badge new-badge">æ–°åŠŸèƒ½</div>
                </div>
                <div class="mode-card" onclick="selectMode('paragraph')">
                    <div class="mode-icon">ğŸ“„</div>
                    <h2>æ®µè½å­¦ä¹ </h2>
                    <p>ä¸Šä¼ è‹±è¯­æ®µè½æˆ–æ–‡ç« ï¼Œè¿›è¡Œå¥ä¹‰è¾¨åˆ«ã€ç»“æ„åˆ†æå’Œæ®µè½é‡ç»„ç»ƒä¹ </p>
                    <div class="mode-badge new-badge">æ–°åŠŸèƒ½</div>
                </div>
                <div class="mode-card mode-card-coming-soon">
                    <div class="mode-icon">ğŸš€</div>
                    <h2>æ•¬è¯·æœŸå¾…</h2>
                    <p>æ›´å¤šç²¾å½©åŠŸèƒ½æ­£åœ¨å¼€å‘ä¸­</p>
                    <p>æ•¬è¯·æœŸå¾…...</p>
                    <div class="mode-badge coming-soon-badge">Coming Soon</div>
                </div>
            </div>
        </div>

        <!-- æ­¥éª¤ä¸€ï¼šææ–™å¯¼å…¥ï¼ˆå¥å­å­¦ä¹ ï¼‰ -->
        <div id="uploadPanel" class="panel" style="display: none;" data-menu-initialized="true">
            <h2>ğŸ“¸ æ­¥éª¤ä¸€ï¼šä¸Šä¼ å­¦ä¹ ææ–™</h2>
            <p style="color: #666; margin-bottom: 20px;">è¯·é€‰æ‹©ä»¥ä¸‹ä»»ä¸€æ–¹å¼æä¾›è‹±è¯­å¥å­</p>
            
            <!-- æ–¹å¼ä¸€ï¼šä¸Šä¼ å›¾ç‰‡ -->
            <div style="margin-bottom: 30px;">
                <h3 style="color: #667eea; font-size: 16px; margin-bottom: 15px;">ğŸ“· æ–¹å¼ä¸€ï¼šä¸Šä¼ å›¾ç‰‡</h3>
                <div class="upload-area" id="uploadArea">
                    <input type="file" id="imageInput" accept="image/*" style="display: none;" data-menu-initialized="true">
                    <div class="upload-prompt">
                        <p>ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ è‹±è¯­å¥å­ç…§ç‰‡</p>
                        <p style="font-size: 0.9em; color: #999;">æ”¯æŒ JPGã€PNG ç­‰å›¾ç‰‡æ ¼å¼</p>
                    </div>
                </div>
                <div id="previewArea"></div>
            </div>
            
            <!-- æ–¹å¼äºŒï¼šç²˜è´´æ–‡æœ¬ -->
            <div>
                <h3 style="color: #667eea; font-size: 16px; margin-bottom: 15px;">ğŸ“ æ–¹å¼äºŒï¼šç²˜è´´æ–‡æœ¬</h3>
                <textarea id="sentenceTextInput" 
                          placeholder="è¯·åœ¨æ­¤ç²˜è´´è‹±è¯­å¥å­..." 
                          style="width: 100%; min-height: 150px; padding: 15px; border: 2px solid #667eea30; border-radius: 10px; font-size: 15px; line-height: 1.8; resize: vertical; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;"></textarea>
                <div style="text-align: center; margin-top: 15px;">
                    <button onclick="analyzeSentenceFromText()" class="btn-primary" style="padding: 12px 30px; font-size: 16px;">å¼€å§‹åˆ†æ</button>
                </div>
            </div>
        </div>

        <!-- ç¿»è¯‘ç»“æœå±•ç¤º -->
        <div id="translationPanel" class="panel" style="display: none;" data-menu-initialized="true">
            <h2>ğŸ“– åŸæ–‡ä¸ç¿»è¯‘</h2>
            <div id="translationResult"></div>
            <button onclick="startLearning()" class="btn-primary">å¼€å§‹é€å¥å­¦ä¹ </button>
        </div>

        <!-- æ­¥éª¤äºŒï¼šå¥å­åˆ†æå­¦ä¹  -->
        <div id="learningPanel" class="panel" style="display: none;" data-menu-initialized="true">
            <div class="progress-bar">
                <div id="progressFill" class="progress-fill"></div>
            </div>
            <p class="progress-text">å¥å­ <span id="currentSentence">1</span> / <span id="totalSentences">0</span></p>
            
            <!-- è¯ä¹‰è¾¨åˆ« -->
            <div id="wordMatchingSection" class="learning-section">
                <h3>ğŸ”¤ è¯ä¹‰è¾¨åˆ«</h3>
                
                <!-- åŸå¥å‚è€ƒ -->
                <div class="sentence-reference">
                    <div class="reference-header">ğŸ“– åŸå¥å‚è€ƒ</div>
                    <div class="reference-content">
                        <div class="english-sentence">
                            <span id="referenceSentenceEn"></span>
                            <button onclick="speakSentence()" class="speak-btn" title="æœ—è¯»å¥å­">ğŸ”Š</button>
                        </div>
                        <div class="chinese-sentence" id="referenceSentenceCn"></div>
                    </div>
                </div>
                
                <p class="instruction">å°†ä¸‹æ–¹çš„ä¸­æ–‡è¯ä¹‰æ‹–æ‹½åˆ°å¯¹åº”çš„è‹±æ–‡å•è¯ä¸‹æ–¹ï¼ˆç‚¹å‡»ğŸ”Šå¯æœ—è¯»å•è¯ï¼‰</p>
                <div id="englishWords" class="word-container"></div>
                <div id="chineseWords" class="word-container draggable-words"></div>
                <button onclick="checkWordMatching()" class="btn-check">æ£€æŸ¥ç­”æ¡ˆ</button>
                <button onclick="nextToStructure()" class="btn-next" style="display: none;" data-menu-initialized="true">ä¸‹ä¸€æ­¥ï¼šç»“æ„åˆ†æ</button>
            </div>

            <!-- ç»“æ„åˆ†æ -->
            <div id="structureSection" class="learning-section" style="display: none;" data-menu-initialized="true">
                <h3>ğŸ—ï¸ å¥å­ç»“æ„åˆ†æ</h3>
                <p class="instruction">å°†å·¦ä¾§çš„è‹±æ–‡å¥å­æˆåˆ†æ‹–æ‹½åˆ°å³ä¾§å¯¹åº”çš„è¯­æ³•æˆåˆ†æ¡†ä¸­</p>
                <div class="structure-layout">
                    <div class="structure-left">
                        <h4>ğŸ“ å¥å­æˆåˆ†</h4>
                        <div id="sentenceParts" class="word-container draggable-words"></div>
                    </div>
                    <div class="structure-right">
                        <h4>ğŸ¯ è¯­æ³•æ¡†</h4>
                        <div id="structureSlots" class="structure-container"></div>
                    </div>
                </div>
                <button onclick="checkStructure()" class="btn-check">æ£€æŸ¥ç­”æ¡ˆ</button>
                <button onclick="nextToReorder()" class="btn-next" style="display: none;" data-menu-initialized="true">ä¸‹ä¸€æ­¥ï¼šå¥å­é‡ç»„</button>
            </div>

            <!-- å¥å­é‡ç»„ -->
            <div id="reorderSection" class="learning-section" style="display: none;" data-menu-initialized="true">
                <h3>ğŸ”„ å¥å­é‡ç»„</h3>
                <p class="instruction">æ ¹æ®ä¸­æ–‡é‡Šä¹‰ï¼Œå°†æ‰“æ•£çš„è‹±æ–‡é‡æ–°ç»„åˆæˆåŸå¥</p>
                <p class="instruction" style="color: #ff9800; font-size: 0.9em;">ğŸ’¡ æç¤ºï¼šåªéœ€æ’åˆ—å•è¯é¡ºåºï¼Œä¸éœ€è¦æ·»åŠ æ ‡ç‚¹ç¬¦å·</p>
                <div id="chineseHint" class="chinese-hint"></div>
                <div id="reorderAnswer" class="reorder-answer" data-placeholder="å°†å•è¯æ‹–æ‹½åˆ°è¿™é‡Œç»„æˆå¥å­"></div>
                <div id="scrambledWords" class="word-container draggable-words"></div>
                <button onclick="checkReorder()" class="btn-check">æ£€æŸ¥ç­”æ¡ˆ</button>
                <button onclick="nextSentence()" class="btn-next" style="display: none;" data-menu-initialized="true">ä¸‹ä¸€å¥</button>
            </div>
        </div>

        <!-- æ­¥éª¤å››ï¼šç”Ÿè¯æœ¬å¤ä¹  -->
        <div id="vocabularyPanel" class="panel" style="display: none;" data-menu-initialized="true">
            <h2>ğŸ“š ç”Ÿè¯æœ¬å¤ä¹ </h2>
            <div id="vocabularyList"></div>
            <button onclick="startVocabReview()" class="btn-primary">å¼€å§‹å¤ä¹ </button>
        </div>

        <!-- ç”Ÿè¯å¤ä¹ ç•Œé¢ - é®ç›–å¼ -->
        <div id="reviewPanel" class="panel" style="display: none;" data-menu-initialized="true">
            <h2>ğŸ“– ç”Ÿè¯æœ¬å¤ä¹ </h2>
            <p class="instruction">å›å¿†å•è¯æ„æ€ï¼Œç‚¹å‡»å¡ç‰‡æŸ¥çœ‹ç­”æ¡ˆ</p>
            <div class="vocab-progress">
                <span>å‰©ä½™: <strong id="remainingCount">0</strong> ä¸ª</span>
                <span>å·²æŒæ¡: <strong id="masteredCount">0</strong> ä¸ª</span>
            </div>
            
            <div class="vocab-card-flip">
                <div class="vocab-card-front" id="vocabFront">
                    <div class="vocab-word" id="vocabWord"></div>
                    <button class="flip-hint" id="flipCardBtn">ç‚¹å‡»æŸ¥çœ‹ç­”æ¡ˆ ğŸ‘‡</button>
                </div>
                
                <div class="vocab-card-back" id="vocabBack" style="display: none;" data-menu-initialized="true">
                    <div class="vocab-answer" id="vocabMeaning"></div>
                    <div class="vocab-buttons">
                        <button id="notRememberBtn" class="btn-not-remember">âŒ æ²¡è®°ä½</button>
                        <button id="rememberBtn" class="btn-remember">âœ… è®°ä½äº†</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ========== å•è¯å­¦ä¹ åŠŸèƒ½ ========== -->
        
        <!-- å•è¯å­¦ä¹ -æ­¥éª¤ä¸€ï¼šè¾“å…¥å•è¯ -->
        <div id="wordUploadPanel" class="panel" style="display: none;" data-menu-initialized="true">
            <h2>ğŸ“ æ­¥éª¤ä¸€ï¼šè¾“å…¥å­¦ä¹ å•è¯</h2>
            <p style="color: #666; margin-bottom: 20px;">è¯·é€‰æ‹©ä»¥ä¸‹ä»»ä¸€æ–¹å¼æä¾›è‹±è¯­å•è¯</p>
            
            <!-- æ–¹å¼ä¸€ï¼šä¸Šä¼ å›¾ç‰‡ -->
            <div style="margin-bottom: 30px;">
                <h3 style="color: #667eea; font-size: 16px; margin-bottom: 15px;">ğŸ“· æ–¹å¼ä¸€ï¼šä¸Šä¼ å›¾ç‰‡</h3>
                <div class="upload-area" id="wordUploadArea">
                    <input type="file" id="wordImageInput" accept="image/*" style="display: none;">
                    <div class="upload-prompt">
                        <p>ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ å•è¯åˆ—è¡¨ç…§ç‰‡</p>
                        <p style="font-size: 0.9em; color: #999;">æ”¯æŒ JPGã€PNG ç­‰å›¾ç‰‡æ ¼å¼</p>
                        <p style="font-size: 0.85em; color: #ff9800; margin-top: 8px;">âš ï¸ æœ€å¤šè¯†åˆ«20ä¸ªå•è¯ï¼Œè¶…å‡ºéƒ¨åˆ†å°†è‡ªåŠ¨å¿½ç•¥</p>
                    </div>
                </div>
            </div>
            
            <!-- æ–¹å¼äºŒï¼šæ‰‹åŠ¨è¾“å…¥ -->
            <div>
                <h3 style="color: #667eea; font-size: 16px; margin-bottom: 15px;">âœï¸ æ–¹å¼äºŒï¼šæ‰‹åŠ¨è¾“å…¥</h3>
                <div class="word-input-container">
                    <p class="instruction">è¯·è¾“å…¥è¦å­¦ä¹ çš„è‹±æ–‡å•è¯ï¼Œæ¯è¡Œä¸€ä¸ªå•è¯ï¼Œæœ€å¤š20ä¸ª</p>
                    <textarea id="wordInputArea" placeholder="ä¾‹å¦‚ï¼š&#10;apple&#10;banana&#10;cat&#10;dog&#10;..."></textarea>
                    <div class="word-count-info">
                        <span id="wordCountDisplay">å·²è¾“å…¥ 0 ä¸ªå•è¯</span>
                        <span class="word-limit-hint">ï¼ˆæœ€å¤š20ä¸ªï¼‰</span>
                    </div>
                </div>
                <div style="text-align: center; margin-top: 15px;">
                    <button id="wordStartBtn" onclick="startWordLearning()" class="btn-primary" style="padding: 12px 30px; font-size: 16px;">å¼€å§‹å­¦ä¹ </button>
                </div>
            </div>
        </div>

        <!-- å•è¯å­¦ä¹ -æ­¥éª¤äºŒï¼šæ•…äº‹å•è¯è®°å¿† -->
        <div id="storyPanel" class="panel" style="display: none;" data-menu-initialized="true">
            <h2>ğŸ“– æ­¥éª¤äºŒï¼šæ•…äº‹å•è¯è®°å¿†</h2>
            <div class="story-container">
                <div class="story-section">
                    <h3>ğŸ‡¨ğŸ‡³ ä¸­æ–‡æ•…äº‹</h3>
                    <div id="chineseStory" class="story-content"></div>
                </div>
                <div class="story-section">
                    <h3>ğŸ‡¬ğŸ‡§ è‹±æ–‡æ•…äº‹</h3>
                    <div id="englishStory" class="story-content"></div>
                </div>
            </div>
            <button onclick="nextToEnglishToChinese()" class="btn-primary">ä¸‹ä¸€æ­¥ï¼šè®°å¿†æ£€æµ‹</button>
        </div>

        <!-- å•è¯å­¦ä¹ -æ­¥éª¤ä¸‰ï¼šå•è¯è®°å¿†æ£€æµ‹ -->
        <div id="englishToChinesePanel" class="panel" style="display: none;" data-menu-initialized="true">
            <h2>ğŸ“ æ­¥éª¤ä¸‰ï¼šå•è¯è®°å¿†æ£€æµ‹</h2>
            <p class="instruction">ğŸ’¡ ç‚¹å‡»è‹±æ–‡å•è¯å¯æŸ¥çœ‹ä¸­æ–‡é‡Šä¹‰ï¼Œå†æ¬¡ç‚¹å‡»æ¢å¤è‹±æ–‡</p>
            <div id="en2cnStory" class="practice-story"></div>
            <div class="encouragement-buttons">
                <button onclick="showWordEncouragement('en2cn')" class="btn-check">âœ… è‹±è¯‘ä¸­æˆ‘å…¨è®°ä½äº†</button>
                <button onclick="showWordEncouragement('cn2en')" class="btn-check">âœ… ä¸­è¯‘è‹±æˆ‘å…¨è®°ä½äº†</button>
            </div>
            <button onclick="finishWordLearning()" class="btn-primary">ä¸‹ä¸€æ­¥ï¼šå­¦ä¹ æ€»ç»“</button>
        </div>

        <!-- å•è¯å­¦ä¹ -æ­¥éª¤å››ï¼šç”Ÿè¯æœ¬æ€»ç»“ -->
        <div id="wordSummaryPanel" class="panel" style="display: none;" data-menu-initialized="true">
            <h2>ğŸ“š æ­¥éª¤å››ï¼šå­¦ä¹ å†…å®¹æ€»ç»“</h2>
            <div id="wordSummaryList" class="vocabulary-summary"></div>
            <div class="export-section">
                <h3>ğŸ“ å¯¼å‡ºå­¦ä¹ æˆæœ</h3>
                <p>å°†æ‰€æœ‰å•è¯å¯¼å‡ºä¸ºæ–‡æ¡£ï¼Œæ–¹ä¾¿æ‰“å°å¤ä¹ </p>
                <button onclick="exportWordLearning()" class="btn-export">ğŸ“¥ å¯¼å‡ºä¸ºæ–‡æ¡£</button>
            </div>
            <div class="return-home-section">
                <button onclick="returnToHome()" class="btn-home">ğŸ  è¿”å›ä¸»é¡µ</button>
            </div>
        </div>

        <!-- å®Œæˆç•Œé¢ - å¯¼å‡ºå­¦ä¹ æˆæœ -->
        <div id="completionPanel" class="panel" style="display: none;" data-menu-initialized="true">
            <h2>ğŸ‰ æ­å–œå®Œæˆæ‰€æœ‰å­¦ä¹ ï¼</h2>
            <div class="completion-summary">
                <h3>ğŸ“Š å­¦ä¹ ç»Ÿè®¡</h3>
                <p>å­¦ä¹ å¥å­ï¼š<strong id="totalSentencesLearned">0</strong> å¥</p>
                <p>æŒæ¡å•è¯ï¼š<strong id="totalWordsMastered">0</strong> ä¸ª</p>
            </div>
            
            <div class="review-content" id="reviewContent" style="display: none;" data-menu-initialized="true">
                <h3>ğŸ“š å­¦ä¹ å†…å®¹é¢„è§ˆ</h3>
                <div id="sentencesReview"></div>
                <div id="vocabularyReview"></div>
            </div>
            
            <div class="export-section">
                <h3>ğŸ“ å¯¼å‡ºå­¦ä¹ æˆæœ</h3>
                <p>å°†æ‰€æœ‰å¥å­å’Œå•è¯å¯¼å‡ºä¸ºæ–‡æ¡£ï¼Œæ–¹ä¾¿æ‰“å°å¤ä¹ </p>
                <button onclick="exportToWord()" class="btn-export">ğŸ“¥ å¯¼å‡ºä¸ºæ–‡æ¡£</button>
            </div>
            
            <div class="return-home-section">
                <button onclick="returnToHome()" class="btn-home">ğŸ  è¿”å›ä¸»é¡µ</button>
            </div>
        </div>

        <!-- æ®µè½å­¦ä¹ -æ­¥éª¤ä¸€ï¼šä¸Šä¼ ææ–™ -->
        <div id="paragraphUploadPanel" class="panel" style="display: none;">
            <h2>ğŸ“¸ æ­¥éª¤ä¸€ï¼šä¸Šä¼ å­¦ä¹ ææ–™</h2>
            <p style="color: #666; margin-bottom: 20px;">è¯·é€‰æ‹©ä»¥ä¸‹ä»»ä¸€æ–¹å¼æä¾›è‹±è¯­æ®µè½æˆ–æ–‡ç« </p>
            
            <!-- æ–¹å¼ä¸€ï¼šä¸Šä¼ å›¾ç‰‡ -->
            <div style="margin-bottom: 30px;">
                <h3 style="color: #667eea; font-size: 16px; margin-bottom: 15px;">ğŸ“· æ–¹å¼ä¸€ï¼šä¸Šä¼ å›¾ç‰‡</h3>
                <div class="upload-area" id="paragraphUploadArea">
                    <input type="file" id="paragraphImageInput" accept="image/*" style="display: none;">
                    <div class="upload-prompt">
                        <p>ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ è‹±è¯­æ®µè½ç…§ç‰‡</p>
                        <p style="font-size: 0.9em; color: #999;">æ”¯æŒ JPGã€PNG ç­‰å›¾ç‰‡æ ¼å¼</p>
                    </div>
                </div>
            </div>
            
            <!-- æ–¹å¼äºŒï¼šç²˜è´´æ–‡æœ¬ -->
            <div>
                <h3 style="color: #667eea; font-size: 16px; margin-bottom: 15px;">ğŸ“ æ–¹å¼äºŒï¼šç²˜è´´æ–‡æœ¬</h3>
                <textarea id="paragraphTextInput" 
                          placeholder="è¯·åœ¨æ­¤ç²˜è´´è‹±è¯­æ®µè½æˆ–æ–‡ç« ..." 
                          style="width: 100%; min-height: 200px; padding: 15px; border: 2px solid #667eea30; border-radius: 10px; font-size: 15px; line-height: 1.8; resize: vertical; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;"></textarea>
                <div style="text-align: center; margin-top: 15px;">
                    <button onclick="analyzeParagraphFromText()" class="btn-primary" style="padding: 12px 30px; font-size: 16px;">å¼€å§‹åˆ†æ</button>
                </div>
            </div>
        </div>

        <!-- æ®µè½å­¦ä¹ -æ­¥éª¤ä¸€ï¼šé€šç¯‡æµè§ˆ -->
        <div id="paragraphOverviewPanel" class="panel" style="display: none;">
            <h2>ğŸ‘€ æ­¥éª¤ä¸€ï¼šé€šç¯‡æµè§ˆ</h2>
            <p style="color: #666; margin-bottom: 20px;">è¯·å…ˆé€šè¯»æ•´ç¯‡è‹±æ–‡åŸæ–‡ï¼Œäº†è§£æ–‡ç« å¤§æ„</p>
            <div id="paragraphFullText" style="max-width: 800px; margin: 0 auto; padding: 30px; background: #f8f9ff; border-radius: 12px; border: 2px solid #667eea30; line-height: 2; font-size: 16px; color: #333;"></div>
            <div style="text-align: center; margin-top: 30px;">
                <button onclick="startParagraphLearning()" class="btn-next">å¼€å§‹å­¦ä¹ </button>
            </div>
        </div>

        <!-- æ®µè½å­¦ä¹ -æ­¥éª¤äºŒï¼šå¥ä¹‰è¾¨åˆ« -->
        <div id="paragraphMeaningPanel" class="panel" style="display: none;">
            <div class="progress-bar">
                <div id="paragraphMeaningProgressFill" class="progress-fill"></div>
            </div>
            <p class="progress-text">æ®µè½ <span id="paragraphMeaningCurrent">1</span> / <span id="paragraphMeaningTotal">0</span></p>
            <h2>ğŸ”¤ æ­¥éª¤äºŒï¼šå¥ä¹‰è¾¨åˆ«</h2>
            <p style="color: #666; margin-bottom: 20px;">å°†ä¸‹æ–¹çš„ä¸­æ–‡ç¿»è¯‘æ‹–æ‹½åˆ°å¯¹åº”çš„è‹±æ–‡å¥å­ä¸‹æ–¹ï¼Œç‚¹å‡»é€‰ä¸­ä¸è®¤è¯†çš„ç”Ÿè¯ï¼ˆä¼šæ ‡çº¢ï¼‰</p>
            <div style="display: flex; flex-direction: column; gap: 20px;">
                <div id="paragraphEnglishSentences"></div>
                <div id="paragraphChineseOptions"></div>
            </div>
            <div style="text-align: center; margin-top: 30px;">
                <button onclick="checkMeaningAnswers()" class="btn-check">æ£€æŸ¥ç­”æ¡ˆ</button>
                <button id="meaningNextBtn" onclick="nextToStructureAnalysis()" class="btn-next" style="display: none;">ä¸‹ä¸€æ­¥ï¼šç»“æ„åˆ†æ</button>
            </div>
        </div>

        <!-- æ®µè½å­¦ä¹ -æ­¥éª¤ä¸‰ï¼šæ®µè½ç»“æ„åˆ†æ -->
        <div id="paragraphStructurePanel" class="panel" style="display: none;">
            <div class="progress-bar">
                <div id="paragraphStructureProgressFill" class="progress-fill"></div>
            </div>
            <p class="progress-text">æ®µè½ <span id="paragraphStructureCurrent">1</span> / <span id="paragraphStructureTotal">0</span></p>
            <h2>ğŸ—ï¸ æ­¥éª¤ä¸‰ï¼šæ®µè½ç»“æ„åˆ†æ</h2>
            <p style="color: #666; margin-bottom: 20px;">ä¸ºæ¯ä¸ªå¥å­é€‰æ‹©å¯¹åº”çš„å¥ç¾¤ï¼ˆæ¯ä¸ªå¥å­åªèƒ½é€‰æ‹©ä¸€ä¸ªå¥ç¾¤ï¼‰</p>
            <div style="display: flex; gap: 20px;">
                <!-- å·¦ä¾§ï¼šå¥å­åˆ—è¡¨ï¼ˆ70%ï¼‰ -->
                <div style="flex: 7;">
                    <h3 style="color: #667eea; margin-bottom: 15px;">ğŸ“ å¥å­åˆ†æ</h3>
                    <div id="sentenceAnalysisList"></div>
                </div>
                
                <!-- å³ä¾§ï¼šå¥ç¾¤æ¦‚è¦ï¼ˆ30%ï¼‰ -->
                <div style="flex: 3;">
                    <h3 style="color: #667eea; margin-bottom: 15px;">ğŸ¯ å¥ç¾¤æ¦‚è¦</h3>
                    <div id="sectionSummaryList"></div>
                </div>
            </div>
            <div style="text-align: center; margin-top: 30px;">
                <button onclick="checkStructureAnswers()" class="btn-check">æ£€æŸ¥ç­”æ¡ˆ</button>
                <button id="structureNextBtn" onclick="nextToParagraphReview()" class="btn-next" style="display: none;">ä¸‹ä¸€æ­¥ï¼šæ®µè½è‡ªæŸ¥</button>
            </div>
        </div>

        <!-- æ®µè½å­¦ä¹ -æ­¥éª¤å››ï¼šæ®µè½è‡ªæŸ¥ -->
        <div id="paragraphReviewPanel" class="panel" style="display: none;">
            <div class="progress-bar">
                <div id="paragraphReviewProgressFill" class="progress-fill"></div>
            </div>
            <p class="progress-text">æ®µè½ <span id="paragraphReviewCurrent">1</span> / <span id="paragraphReviewTotal">0</span></p>
            <h2>ğŸ”„ æ­¥éª¤å››ï¼šæ®µè½è‡ªæŸ¥</h2>
            <p style="color: #666; margin-bottom: 20px;">æ‹–æ‹½å¥å­ï¼Œå°†å®ƒä»¬æ’åˆ—æˆæ­£ç¡®çš„é¡ºåº</p>
            <div id="paragraphReviewSentences"></div>
            <div style="text-align: center; margin-top: 30px;">
                <button onclick="checkReviewAnswers()" class="btn-check">æ£€æŸ¥ç­”æ¡ˆ</button>
                <button id="reviewNextBtn" onclick="nextParagraphOrFinish()" class="btn-next" style="display: none;">ä¸‹ä¸€æ®µ â†’</button>
            </div>
        </div>

        <!-- æ®µè½å­¦ä¹ -æ­¥éª¤äº”ï¼šæ®µè½æ€»ç»“ -->
        <div id="paragraphSummaryPanel" class="panel" style="display: none;">
            <h2>ğŸ“ æ­¥éª¤äº”ï¼šæ®µè½æ€»ç»“</h2>
            <p style="color: #666; margin-bottom: 20px;">å°†å·¦ä¾§æ®µè½ä¸å³ä¾§å¯¹åº”çš„æ®µè½å¤§æ„è¿›è¡ŒåŒ¹é…</p>
            <div id="summaryMatching"></div>
            <div style="text-align: center; margin-top: 30px;">
                <button onclick="checkSummaryAnswers()" class="btn-check">æ£€æŸ¥ç­”æ¡ˆ</button>
                <button id="summaryNextBtn" onclick="nextToComprehensionOrNextParagraph()" class="btn-next" style="display: none;">ä¸‹ä¸€æ­¥ï¼šæ®µè½ç†è§£</button>
            </div>
        </div>

        <!-- æ®µè½å­¦ä¹ -æ­¥éª¤å…­ï¼šæ®µè½ç†è§£ -->
        <div id="paragraphComprehensionPanel" class="panel" style="display: none;">
            <h2>ğŸ§  æ­¥éª¤å…­ï¼šæ®µè½ç†è§£</h2>
            <p style="color: #666; margin-bottom: 20px;">æ ¹æ®æ®µè½å†…å®¹å›ç­”ä»¥ä¸‹é—®é¢˜</p>
            <div id="comprehensionQuestions"></div>
            <div style="text-align: center; margin-top: 30px;">
                <button onclick="checkComprehensionAnswers()" class="btn-check">æ£€æŸ¥ç­”æ¡ˆ</button>
                <button id="comprehensionNextBtn" onclick="finishParagraphLearning()" class="btn-next" style="display: none;">å®Œæˆå­¦ä¹ </button>
            </div>
        </div>

        <!-- æ®µè½å­¦ä¹ -å®Œæˆé¡µé¢ -->
        <div id="paragraphCompletionPanel" class="panel" style="display: none;">
            <h2>ğŸ‰ æ­å–œå®Œæˆæ‰€æœ‰å­¦ä¹ ï¼</h2>
            <div class="completion-summary">
                <h3>ğŸ“Š å­¦ä¹ ç»Ÿè®¡</h3>
                <p>å­¦ä¹ æ®µè½ï¼š<strong id="totalParagraphsLearned">0</strong> æ®µ</p>
                <p>æŒæ¡å•è¯ï¼š<strong id="totalVocabularyMastered">0</strong> ä¸ª</p>
            </div>
            
            <div class="review-content">
                <h3>ğŸ“š æ®µè½ç»“æ„åˆ†æ</h3>
                <div id="paragraphReviewContent"></div>
            </div>
            
            <div class="review-content">
                <h3>ğŸ“– ç”Ÿè¯æœ¬</h3>
                <div id="paragraphVocabularyReview"></div>
            </div>
            
            <div class="export-section">
                <h3>ğŸ“ å¯¼å‡ºå­¦ä¹ æˆæœ</h3>
                <p>å°†æ®µè½åˆ†æå’Œå•è¯å¯¼å‡ºä¸ºæ–‡æ¡£ï¼Œæ–¹ä¾¿æ‰“å°å¤ä¹ </p>
                <button onclick="exportParagraphLearning()" class="btn-export">ğŸ“¥ å¯¼å‡ºä¸ºæ–‡æ¡£</button>
            </div>
            
            <div class="return-home-section">
                <button onclick="returnToHome()" class="btn-home">ğŸ  è¿”å›ä¸»é¡µ</button>
            </div>
        </div>

        <!-- é¼“åŠ±åŠ¨ç”» -->
        <div id="encouragement" class="encouragement"></div>
        
        <!-- æ‚¬æµ®ç”Ÿè¯æœ¬ -->
        <div id="floatingVocabBall" style="display: none; position: fixed; right: 30px; top: 50%; transform: translateY(-50%); z-index: 9999;">
            <div class="vocab-ball" onclick="toggleVocabPanel()" style="width: 65px; height: 65px; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); border-radius: 15px; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 6px 20px rgba(240, 147, 251, 0.4); transition: all 0.3s; animation: vocabFloat 3s ease-in-out infinite;">
                <span style="color: white; font-size: 28px; pointer-events: none;">ğŸ“š</span>
            </div>
            <div id="floatingVocabPanel" style="display: none; position: absolute; right: 80px; top: 0; width: 300px; max-height: 400px; overflow-y: auto; background: white; border-radius: 12px; box-shadow: 0 8px 24px rgba(0,0,0,0.15); padding: 15px; opacity: 0; transform: translateX(20px); transition: all 0.3s ease-out;">
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                    <h4 style="color: #f5576c; margin: 0; font-size: 16px; font-weight: 600;">ğŸ“š ç”Ÿè¯æœ¬</h4>
                    <button onclick="toggleVocabPanel()" style="background: none; border: none; color: #999; cursor: pointer; font-size: 20px; padding: 0; line-height: 1;">Ã—</button>
                </div>
                <div id="floatingVocabList"></div>
            </div>
        </div>
        <style>
            @keyframes vocabFloat {
                0%, 100% { transform: translateY(-50%) translateX(0); }
                50% { transform: translateY(-50%) translateX(-5px); }
            }
            .vocab-ball:hover {
                transform: scale(1.1) rotate(5deg);
                box-shadow: 0 8px 25px rgba(240, 147, 251, 0.6);
            }
            #floatingVocabPanel.active {
                display: block !important;
                opacity: 1 !important;
                transform: translateX(0) !important;
            }
        </style>
    </div>

    <!-- å…¨å±€å˜é‡ -->
    <script src="api-client.js?t=20251103170200"></script>
    <script src="app.js?t=20251103173200"></script>
    <script src="learning.js?v=7.13"></script>
    <script src="word-learning.js?t=20251103105700"></script>
    <script src="paragraph-learning.js?t=20251103130300"></script>
</body>
<script>
// ========== è¯­éŸ³ç³»ç»Ÿ ==========
let selectedVoice = null;
let voiceRate = 1.0;
let voicePitch = 1.0;
let allVoices = [];

// åˆå§‹åŒ–è¯­éŸ³
function initVoices() {
    console.log('ğŸ¤ å¼€å§‹åˆå§‹åŒ–è¯­éŸ³ç³»ç»Ÿ...');
    return new Promise((resolve) => {
        let voices = speechSynthesis.getVoices();
        console.log('ğŸ¤ é¦–æ¬¡è·å–è¯­éŸ³æ•°é‡:', voices.length);
        
        if (voices.length > 0) {
            console.log('âœ… è¯­éŸ³å·²åŠ è½½ï¼Œç«‹å³å¡«å……é€‰æ‹©å™¨');
            allVoices = voices;
            selectBestVoice(voices);
            populateVoiceSelector(voices);
            resolve(voices);
        } else {
            console.log('â³ è¯­éŸ³æœªåŠ è½½ï¼Œç­‰å¾…onvoiceschangedäº‹ä»¶...');
            speechSynthesis.onvoiceschanged = () => {
                voices = speechSynthesis.getVoices();
                console.log('âœ… onvoiceschangedè§¦å‘ï¼Œè·å–åˆ°', voices.length, 'ä¸ªè¯­éŸ³');
                allVoices = voices;
                selectBestVoice(voices);
                populateVoiceSelector(voices);
                resolve(voices);
            };
        }
    });
}

// å¡«å……è¯­éŸ³é€‰æ‹©å™¨
function populateVoiceSelector(voices) {
    console.log('ğŸ“ populateVoiceSelectorè¢«è°ƒç”¨ï¼Œvoicesæ•°é‡:', voices.length);
    const voiceSelect = document.getElementById('voiceSelect');
    console.log('ğŸ“ voiceSelectå…ƒç´ :', voiceSelect);
    
    if (!voiceSelect) {
        console.warn('âš ï¸ voiceSelectå…ƒç´ æœªæ‰¾åˆ°ï¼Œç¨åé‡è¯•...');
        console.log('ğŸ“ å½“å‰DOMçŠ¶æ€:', document.readyState);
        console.log('ğŸ“ bodyæ˜¯å¦å­˜åœ¨:', !!document.body);
        
        // å¦‚æœå…ƒç´ è¿˜æ²¡åŠ è½½ï¼Œç­‰å¾…ä¸€ä¸‹å†è¯•
        setTimeout(() => {
            const retrySelect = document.getElementById('voiceSelect');
            if (retrySelect) {
                console.log('âœ… é‡è¯•æˆåŠŸï¼Œå¼€å§‹å¡«å……è¯­éŸ³é€‰æ‹©å™¨');
                populateVoiceSelector(voices);
            } else {
                console.error('âŒ voiceSelectå…ƒç´ å§‹ç»ˆæœªæ‰¾åˆ°');
                console.log('ğŸ“ æ‰€æœ‰selectå…ƒç´ :', document.querySelectorAll('select'));
            }
        }, 500);
        return;
    }
    
    console.log('ğŸ¤ å¼€å§‹å¡«å……è¯­éŸ³é€‰æ‹©å™¨ï¼Œå…±', voices.length, 'ä¸ªè¯­éŸ³');
    console.log('ğŸ“ voiceSelectå½“å‰innerHTMLé•¿åº¦:', voiceSelect.innerHTML.length);
    
    voiceSelect.innerHTML = '';
    console.log('ğŸ“ å·²æ¸…ç©ºvoiceSelect');
    
    // åˆ†ç±»è¯­éŸ³
    const categories = {
        'ç¾å¼è‹±è¯­': [],
        'è‹±å¼è‹±è¯­': [],
        'è¶£å‘³å‘éŸ³': [],
        'å…¶ä»–å‘éŸ³': []
    };
    
    // ç¾å¼è‹±è¯­ç™½åå•ï¼ˆæŒ‰é¡ºåºï¼‰
    // macOS: Aaron, Nicky, Samantha, Fred, Alex
    // Windows: Zira, David, Mark, Guy, Aria
    const allowedUSVoices = [
        'Aaron', 'Nicky', 'Samantha', 'Fred', 'Alex',  // macOS
        'Zira', 'David', 'Mark', 'Guy', 'Aria',        // Windows
        'Google US English', 'Google', 'Microsoft'
    ];
    // è‹±å¼è‹±è¯­ç™½åå•ï¼ˆæŒ‰é¡ºåºï¼‰
    // macOS: Arthur, Daniel, Martha, Oliver
    // Windows: Hazel, George, Susan
    const allowedGBVoices = [
        'Arthur', 'Daniel', 'Martha', 'Oliver',        // macOS
        'Hazel', 'George', 'Susan',                    // Windows
        'Google UK English', 'Google', 'Microsoft'
    ];
    // è¶£å‘³å‘éŸ³åå•ï¼ˆä¸»è¦æ˜¯macOSï¼‰
    const funVoices = ['Bubbles', 'Trinoids', 'Zarvox'];
    // å…¶ä»–å‘éŸ³åå•
    // macOS: Catherine, Gordon, Moira, Karen, Fiona, Tessa
    // Windows: å…¶ä»–è‹±è¯­è¯­éŸ³
    const allowedOtherVoices = [
        'Catherine', 'Gordon', 'Moira', 'Karen', 'Fiona', 'Tessa',  // macOS
        'Linda', 'Richard', 'Heera', 'Ravi'                         // Windowså…¶ä»–
    ];
    
    // è°ƒè¯•ï¼šæ‰“å°æ‰€æœ‰è‹±è¯­è¯­éŸ³
    console.log('ğŸ” å¯ç”¨çš„è‹±è¯­è¯­éŸ³åˆ—è¡¨:');
    const englishVoices = voices.filter(v => v.lang.startsWith('en'));
    console.log(`æ€»å…±æ‰¾åˆ° ${englishVoices.length} ä¸ªè‹±è¯­è¯­éŸ³`);
    englishVoices.forEach(v => {
        console.log(`  - ${v.name} (${v.lang}) ${v.localService ? '[æœ¬åœ°]' : '[åœ¨çº¿]'}`);
    });
    
    // ç‰¹åˆ«æ£€æŸ¥Googleè¯­éŸ³
    const googleVoices = voices.filter(v => v.name.toLowerCase().includes('google'));
    console.log(`ğŸ” æ‰¾åˆ° ${googleVoices.length} ä¸ªGoogleè¯­éŸ³:`);
    googleVoices.forEach(v => {
        console.log(`  - ${v.name} (${v.lang})`);
    });
    
    voices.forEach((voice, index) => {
        if (!voice.lang.startsWith('en')) return;
        
        // æ£€æŸ¥æ˜¯å¦æ˜¯è¶£å‘³å‘éŸ³
        const isFunVoice = funVoices.some(name => voice.name.includes(name));
        if (isFunVoice) {
            categories['è¶£å‘³å‘éŸ³'].push({voice, index});
            return;
        }
        
        // æ£€æŸ¥æ˜¯å¦æ˜¯å…è®¸çš„ç¾å¼è‹±è¯­ï¼ˆä½¿ç”¨æ›´å®½æ¾çš„åŒ¹é…ï¼‰
        const isAllowedUS = allowedUSVoices.some(name => {
            const voiceLower = voice.name.toLowerCase();
            const nameLower = name.toLowerCase();
            
            // å¯¹äºGoogleè¯­éŸ³ï¼ŒåªåŒ¹é…å…³é”®è¯
            if (nameLower.includes('google')) {
                return voiceLower.includes('google') && 
                       (voiceLower.includes('us') || voiceLower.includes('united states') || 
                        (voice.lang.includes('en-US') && !voiceLower.includes('uk') && !voiceLower.includes('british')));
            }
            // å¯¹äºMicrosoftè¯­éŸ³
            if (nameLower.includes('microsoft')) {
                return voiceLower.includes('microsoft') && 
                       (voiceLower.includes('us') || voice.lang.includes('en-US'));
            }
            return voice.name.includes(name);
        });
        if (isAllowedUS) {
            categories['ç¾å¼è‹±è¯­'].push({voice, index});
            return;
        }
        
        // æ£€æŸ¥æ˜¯å¦æ˜¯å…è®¸çš„è‹±å¼è‹±è¯­ï¼ˆä½¿ç”¨æ›´å®½æ¾çš„åŒ¹é…ï¼‰
        const isAllowedGB = allowedGBVoices.some(name => {
            const voiceLower = voice.name.toLowerCase();
            const nameLower = name.toLowerCase();
            
            // å¯¹äºGoogleè¯­éŸ³ï¼ŒåªåŒ¹é…å…³é”®è¯
            if (nameLower.includes('google')) {
                return voiceLower.includes('google') && 
                       (voiceLower.includes('uk') || voiceLower.includes('british') || voice.lang.includes('en-GB'));
            }
            // å¯¹äºMicrosoftè¯­éŸ³
            if (nameLower.includes('microsoft')) {
                return voiceLower.includes('microsoft') && 
                       (voiceLower.includes('uk') || voiceLower.includes('gb') || voice.lang.includes('en-GB'));
            }
            return voice.name.includes(name);
        });
        if (isAllowedGB) {
            categories['è‹±å¼è‹±è¯­'].push({voice, index});
            return;
        }
        
        // æ£€æŸ¥æ˜¯å¦æ˜¯å…è®¸çš„å…¶ä»–å‘éŸ³
        const isAllowedOther = allowedOtherVoices.some(name => voice.name.includes(name));
        if (isAllowedOther) {
            categories['å…¶ä»–å‘éŸ³'].push({voice, index});
        }
    });
    
    // æŒ‰æŒ‡å®šé¡ºåºæ’åº
    const sortByOrder = (items, orderList) => {
        return items.sort((a, b) => {
            const aIndex = orderList.findIndex(name => a.voice.name.includes(name));
            const bIndex = orderList.findIndex(name => b.voice.name.includes(name));
            return aIndex - bIndex;
        });
    };
    
    categories['ç¾å¼è‹±è¯­'] = sortByOrder(categories['ç¾å¼è‹±è¯­'], allowedUSVoices);
    categories['è‹±å¼è‹±è¯­'] = sortByOrder(categories['è‹±å¼è‹±è¯­'], allowedGBVoices);
    
    // è°ƒè¯•ï¼šæ‰“å°åˆ†ç±»ç»“æœ
    console.log('ğŸ“Š è¯­éŸ³åˆ†ç±»ç»“æœ:');
    Object.keys(categories).forEach(cat => {
        console.log(`  ${cat}: ${categories[cat].length} ä¸ª`);
        categories[cat].forEach(({voice}) => {
            console.log(`    - ${voice.name}`);
        });
    });
    
    // æ·»åŠ é€‰é¡¹
    Object.keys(categories).forEach(category => {
        if (categories[category].length > 0) {
            const optgroup = document.createElement('optgroup');
            optgroup.label = category;
            
            categories[category].forEach(({voice, index}) => {
                const option = document.createElement('option');
                option.value = index;
                
                // ä¸ºGoogleè¯­éŸ³æ·»åŠ VPNæ ‡æ³¨
                const vpnTag = voice.name.includes('Google') ? ' ğŸŒéœ€VPN' : '';
                option.textContent = `${voice.name} (${voice.lang})${vpnTag}`;
                
                if (selectedVoice && selectedVoice.name === voice.name) {
                    option.selected = true;
                }
                optgroup.appendChild(option);
            });
            
            voiceSelect.appendChild(optgroup);
        }
    });
}

// æ›´æ”¹è¯­éŸ³
function changeVoice() {
    const voiceSelect = document.getElementById('voiceSelect');
    const selectedIndex = voiceSelect.value;
    if (selectedIndex !== '') {
        selectedVoice = allVoices[selectedIndex];
        console.log('é€‰æ‹©è¯­éŸ³:', selectedVoice.name, selectedVoice.lang);
        // ä¿å­˜åˆ°localStorage
        localStorage.setItem('selectedVoiceIndex', selectedIndex);
    }
}

// æµ‹è¯•è¯­éŸ³
function testVoice() {
    if (!selectedVoice) {
        alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè¯­éŸ³');
        return;
    }
    // åœæ­¢å½“å‰æ­£åœ¨æ’­æ”¾çš„è¯­éŸ³
    speechSynthesis.cancel();
    
    // ç­‰å¾…ä¸€å°æ®µæ—¶é—´ç¡®ä¿åœæ­¢å®Œæˆ
    setTimeout(() => {
        const utterance = new SpeechSynthesisUtterance('Hello, this is a test. I am your English learning assistant.');
        utterance.voice = selectedVoice;
        utterance.rate = voiceRate;
        utterance.pitch = voicePitch;
        speechSynthesis.speak(utterance);
    }, 100);
}

// åˆ‡æ¢è¯­éŸ³é¢æ¿æ˜¾ç¤º/éšè—
function toggleVoicePanel() {
    const content = document.getElementById('voiceSelectorContent');
    if (content) {
        content.classList.toggle('active');
    }
}

// å…³é—­è¯­éŸ³é¢æ¿ï¼ˆåªå…³é—­é¢æ¿ï¼Œä¸éšè—è¯­éŸ³çƒï¼‰
function closeVoicePanel() {
    const content = document.getElementById('voiceSelectorContent');
    if (content) {
        content.classList.remove('active');
    }
}

// é€‰æ‹©æœ€ä½³è¯­éŸ³ï¼ˆä¼˜å…ˆå¥³å£°ã€ç¾å¼è‹±è¯­ï¼‰
function selectBestVoice(voices) {
    const priorities = [
        v => v.name.includes('Google') && v.name.includes('US') && v.name.includes('Female'),
        v => v.name.includes('Samantha'),
        v => v.name.includes('Zira'),
        v => v.name.includes('Female') && v.lang.startsWith('en'),
        v => v.name.includes('female') && v.lang.startsWith('en'),
        v => v.lang === 'en-US',
        v => v.lang.startsWith('en-US'),
        v => v.lang.startsWith('en')
    ];
    
    for (const priority of priorities) {
        const voice = voices.find(priority);
        if (voice) {
            selectedVoice = voice;
            console.log('é€‰æ‹©è¯­éŸ³:', voice.name, voice.lang);
            return;
        }
    }
    
    selectedVoice = voices.find(v => v.lang.startsWith('en')) || voices[0];
    console.log('ä½¿ç”¨é»˜è®¤è¯­éŸ³:', selectedVoice?.name);
}

// æœ—è¯»æ–‡æœ¬
function speak(text, options = {}) {
    speechSynthesis.cancel();
    if (!text) return;
    
    const utterance = new SpeechSynthesisUtterance(text);
    if (selectedVoice) utterance.voice = selectedVoice;
    
    utterance.rate = options.rate || voiceRate;
    utterance.pitch = options.pitch || voicePitch;
    utterance.volume = options.volume || 1.0;
    utterance.lang = options.lang || 'en-US';
    
    utterance.onerror = (e) => console.error('è¯­éŸ³é”™è¯¯:', e);
    speechSynthesis.speak(utterance);
}

// æœ—è¯»å¥å­
function speakSentence() {
    const sentence = document.getElementById('referenceSentenceEn')?.textContent;
    if (sentence) speak(sentence, { rate: 0.9 });
}

// æœ—è¯»å•è¯
function speakWord(word) {
    if (word) speak(word, { rate: 0.8 });
}

// åˆå§‹åŒ– - ç¡®ä¿DOMåŠ è½½å®Œæˆåå†åˆå§‹åŒ–è¯­éŸ³
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
        console.log('ğŸ“¢ DOMåŠ è½½å®Œæˆï¼Œåˆå§‹åŒ–è¯­éŸ³ç³»ç»Ÿ...');
        initVoices();
    });
} else {
    console.log('ğŸ“¢ DOMå·²å°±ç»ªï¼Œç«‹å³åˆå§‹åŒ–è¯­éŸ³ç³»ç»Ÿ...');
    initVoices();
}
</script>

<!-- è®¾å¤‡ç®¡ç†å¼¹çª— -->
<div id="deviceManagerModal" style="display: none; position: fixed; z-index: 10000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);">
    <div style="background-color: white; margin: 10% auto; padding: 30px; border-radius: 12px; width: 90%; max-width: 500px; box-shadow: 0 4px 20px rgba(0,0,0,0.2);">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2 style="margin: 0;">ğŸ“± è®¾å¤‡ç®¡ç†</h2>
            <span onclick="closeDeviceManager()" style="font-size: 28px; cursor: pointer; color: #aaa;">&times;</span>
        </div>
        <p style="color: #666; font-size: 14px; margin-bottom: 20px;">æ‚¨æœ€å¤šå¯ä»¥åœ¨2å°è®¾å¤‡ä¸Šç™»å½•ä½¿ç”¨</p>
        <div id="deviceList" style="margin-top: 20px;">
            <div style="text-align: center; padding: 20px; color: #666;">åŠ è½½ä¸­...</div>
        </div>
    </div>
</div>

<script>
// è®¾å¤‡æŒ‡çº¹ç”Ÿæˆ
async function getDeviceFingerprint() {
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    ctx.textBaseline = 'top';
    ctx.font = '14px Arial';
    ctx.fillText('fp', 2, 2);
    
    const fp = [
        navigator.userAgent,
        navigator.language,
        screen.width + 'x' + screen.height,
        new Date().getTimezoneOffset(),
        canvas.toDataURL()
    ].join('|');
    
    let hash = 0;
    for (let i = 0; i < fp.length; i++) {
        hash = ((hash << 5) - hash) + fp.charCodeAt(i);
        hash = hash & hash;
    }
    return 'fp_' + Math.abs(hash).toString(36);
}

// æ˜¾ç¤ºè®¾å¤‡ç®¡ç†å™¨
async function showDeviceManager() {
    document.getElementById('deviceManagerModal').style.display = 'block';
    await loadDevices();
}

// å…³é—­è®¾å¤‡ç®¡ç†å™¨
function closeDeviceManager() {
    document.getElementById('deviceManagerModal').style.display = 'none';
}

// åŠ è½½è®¾å¤‡åˆ—è¡¨
async function loadDevices() {
    const deviceList = document.getElementById('deviceList');
    const token = localStorage.getItem('authToken');
    
    if (!token) {
        deviceList.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">è¯·å…ˆç™»å½•</div>';
        return;
    }

    try {
        const response = await fetch('http://localhost:3001/api/auth/devices', {
            headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!response.ok) throw new Error('è·å–è®¾å¤‡åˆ—è¡¨å¤±è´¥');

        const data = await response.json();
        console.log('ğŸ“± è®¾å¤‡ç®¡ç† - APIè¿”å›æ•°æ®:', data);
        
        const devices = data.devices || [];
        console.log('ğŸ“± è®¾å¤‡ç®¡ç† - è®¾å¤‡åˆ—è¡¨:', devices);
        console.log('ğŸ“± è®¾å¤‡ç®¡ç† - è®¾å¤‡æ•°é‡:', devices.length);

        if (devices.length === 0) {
            deviceList.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">æš‚æ— è®¾å¤‡è®°å½•</div>';
            return;
        }

        const currentFp = await getDeviceFingerprint();

        deviceList.innerHTML = devices.map(device => {
            const isCurrent = device.device_fingerprint === currentFp;
            const lastUsed = new Date(device.last_used_at).toLocaleString('zh-CN');
            const deviceName = device.device_name || 'æœªçŸ¥è®¾å¤‡';
            
            return `
                <div style="background: ${isCurrent ? '#e8f5e9' : '#f9f9f9'}; border: 1px solid ${isCurrent ? '#4CAF50' : '#ddd'}; border-radius: 8px; padding: 15px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center;">
                    <div style="flex: 1;">
                        <div style="font-weight: bold; color: #333; margin-bottom: 5px;">
                            ğŸ“± ${deviceName.substring(0, 30)}...
                            ${isCurrent ? '<span style="background: #4CAF50; color: white; padding: 2px 8px; border-radius: 4px; font-size: 12px; margin-left: 8px;">å½“å‰è®¾å¤‡</span>' : ''}
                        </div>
                        <div style="font-size: 12px; color: #666;">æœ€åä½¿ç”¨: ${lastUsed}</div>
                    </div>
                    ${!isCurrent ? `<button onclick="removeDevice(${device.id})" style="background: #f44336; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">è§£ç»‘</button>` : ''}
                </div>
            `;
        }).join('');

    } catch (error) {
        console.error('åŠ è½½è®¾å¤‡åˆ—è¡¨é”™è¯¯:', error);
        deviceList.innerHTML = '<div style="text-align: center; color: #f44336; padding: 20px;">åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•</div>';
    }
}

// åˆ é™¤è®¾å¤‡
async function removeDevice(deviceId) {
    if (!confirm('ç¡®å®šè¦è§£ç»‘æ­¤è®¾å¤‡å—ï¼Ÿè§£ç»‘åè¯¥è®¾å¤‡å°†æ— æ³•ç»§ç»­ä½¿ç”¨ï¼Œéœ€è¦é‡æ–°ç™»å½•ã€‚')) {
        return;
    }

    const token = localStorage.getItem('authToken');

    try {
        const response = await fetch(`http://localhost:3001/api/auth/devices/${deviceId}`, {
            method: 'DELETE',
            headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!response.ok) throw new Error('åˆ é™¤è®¾å¤‡å¤±è´¥');

        alert('è®¾å¤‡å·²è§£ç»‘æˆåŠŸï¼');
        await loadDevices();

    } catch (error) {
        console.error('åˆ é™¤è®¾å¤‡é”™è¯¯:', error);
        alert('åˆ é™¤è®¾å¤‡å¤±è´¥: ' + error.message);
    }
}

// ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
window.addEventListener('click', function(event) {
    const modal = document.getElementById('deviceManagerModal');
    if (event.target === modal) {
        closeDeviceManager();
    }
});
</script>
<script>
// æœ€ç®€å•çš„èœå•æ§åˆ¶ - åªç”¨ç‚¹å‡»
(function initLogoutMenu() {
    const btn = document.getElementById('logoutButton');
    if (!btn) {
        // å¦‚æœæŒ‰é’®è¿˜ä¸å­˜åœ¨ï¼Œç­‰å¾…DOMåŠ è½½å®Œæˆåå†è¯•
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initLogoutMenu);
        }
        return;
    }
    
    // é˜²æ­¢é‡å¤åˆå§‹åŒ–
    if (btn.dataset.menuInitialized === 'true') {
        return;
    }
    btn.dataset.menuInitialized = 'true';
    
    const icon = btn.querySelector('.logout-btn-icon');
    const menu = btn.querySelector('.logout-btn-content');
    if (!icon || !menu) return;
    
    let isOpen = false;
    
    // ç‚¹å‡»å›¾æ ‡åˆ‡æ¢
    icon.onclick = function(e) {
        e.stopPropagation();
        isOpen = !isOpen;
        menu.style.display = isOpen ? 'block' : 'none';
    };
    
    // ç‚¹å‡»å¤–éƒ¨å…³é—­
    document.onclick = function(e) {
        if (!btn.contains(e.target)) {
            isOpen = false;
            menu.style.display = 'none';
        }
    };
    
    // ç‚¹å‡»èœå•å†…éƒ¨ä¸å…³é—­ï¼ˆé™¤äº†ç™»å‡ºï¼‰
    menu.onclick = function(e) {
        if (e.target.textContent.includes('ç™»å‡º')) {
            isOpen = false;
            menu.style.display = 'none';
        }
        e.stopPropagation();
    };
})();
</script>
<script>
// å¤„ç†æ”¯ä»˜å›è°ƒ
(async function handlePaymentCallback() {
    const urlParams = new URLSearchParams(window.location.search);
    const paymentSuccess = urlParams.get('payment');
    const planType = urlParams.get('plan');
    
    if (paymentSuccess === 'success' && planType) {
        console.log('ğŸ’° æ£€æµ‹åˆ°æ”¯ä»˜æˆåŠŸè¿”å›:', { planType });
        
        const token = localStorage.getItem('authToken');
        if (!token) {
            console.error('æœªæ‰¾åˆ°token');
            return;
        }
        
        try {
            // è§£ætokenè·å–userId
            const tokenParts = token.split('.');
            const payload = JSON.parse(atob(tokenParts[1]));
            const userId = payload.id;
            
            // è°ƒç”¨æ”¯ä»˜å›è°ƒAPI
            const callbackResponse = await fetch(`${API_BASE_URL}/auth/payment-callback`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    userId,
                    planType,
                    paymentId: 'manual_' + Date.now()
                })
            });
            
            const callbackData = await callbackResponse.json();
            
            if (callbackResponse.ok) {
                alert(`ğŸ‰ ${callbackData.message}\n\nå·²å¢åŠ  ${callbackData.subscription.daysAdded} å¤©ä¼šå‘˜æ—¶é•¿ï¼\n\nå‰©ä½™æ—¶é—´ï¼š${callbackData.subscription.remainingDays} å¤©`);
                
                // æ¸…é™¤URLå‚æ•°
                window.history.replaceState({}, document.title, window.location.pathname);
                
                // åˆ·æ–°é¡µé¢ä»¥æ›´æ–°ä¼šå‘˜çŠ¶æ€
                window.location.reload();
            } else {
                alert('âš ï¸ ' + (callbackData.error || 'å¤„ç†æ”¯ä»˜å¤±è´¥'));
                console.error('æ”¯ä»˜å›è°ƒå¤±è´¥:', callbackData);
            }
        } catch (error) {
            console.error('å¤„ç†æ”¯ä»˜å›è°ƒé”™è¯¯:', error);
            alert('âš ï¸ å¤„ç†æ”¯ä»˜æ—¶å‘ç”Ÿé”™è¯¯ï¼Œè¯·è”ç³»å®¢æœ');
        }
    }
})();
</script>
</html>
